name: Build and Publish macOS App

on:
  push:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-publish:
    runs-on: macos-15
    env:
      PRODUCT_NAME: PRPulseApp
      DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Build release app bundle archives
        shell: bash
        run: |
          set -euo pipefail
          swift build -c release --product "$PRODUCT_NAME"
          BIN_PATH="$(swift build -c release --show-bin-path)"

          mkdir -p dist
          APP_BUNDLE="dist/${PRODUCT_NAME}.app"
          APP_CONTENTS="${APP_BUNDLE}/Contents"
          APP_MACOS="${APP_CONTENTS}/MacOS"
          APP_RESOURCES="${APP_CONTENTS}/Resources"
          mkdir -p "$APP_MACOS" "$APP_RESOURCES"

          cp "$BIN_PATH/$PRODUCT_NAME" "$APP_MACOS/$PRODUCT_NAME"
          chmod +x "$APP_MACOS/$PRODUCT_NAME"

          if [ -d "$BIN_PATH/${PRODUCT_NAME}_${PRODUCT_NAME}.resources" ]; then
            cp -R "$BIN_PATH/${PRODUCT_NAME}_${PRODUCT_NAME}.resources" "$APP_RESOURCES/"
          fi

          cat > "${APP_CONTENTS}/Info.plist" <<'PLIST'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>CFBundleDisplayName</key>
            <string>PR Pulse</string>
            <key>CFBundleExecutable</key>
            <string>PRPulseApp</string>
            <key>CFBundleIdentifier</key>
            <string>dev.prpulse.app</string>
            <key>CFBundleName</key>
            <string>PRPulse</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>CFBundleShortVersionString</key>
            <string>0.1.0</string>
            <key>CFBundleVersion</key>
            <string>1</string>
            <key>LSMinimumSystemVersion</key>
            <string>13.0</string>
            <key>LSUIElement</key>
            <true/>
          </dict>
          </plist>
          PLIST

          ARCHIVE_NAME="${PRODUCT_NAME}-macos-${GITHUB_SHA}.tar.gz"
          tar -czf "dist/$ARCHIVE_NAME" -C dist "${PRODUCT_NAME}.app"

          ZIP_NAME="${PRODUCT_NAME}-macos-${GITHUB_SHA}.zip"
          ditto -c -k --sequesterRsrc --keepParent "dist/${PRODUCT_NAME}.app" "dist/${ZIP_NAME}"

          DMG_NAME="${PRODUCT_NAME}-macos-${GITHUB_SHA}.dmg"
          DMG_ROOT="dist/dmg-root"
          rm -rf "$DMG_ROOT"
          mkdir -p "$DMG_ROOT"
          cp -R "dist/${PRODUCT_NAME}.app" "$DMG_ROOT/"
          ln -s /Applications "$DMG_ROOT/Applications"
          hdiutil create -volname "PR Pulse" -srcfolder "$DMG_ROOT" -ov -format UDZO "dist/${DMG_NAME}"
          # Simple end-user filenames for releases
          cp "dist/${DMG_NAME}" "dist/${PRODUCT_NAME}.dmg"
          if [[ "${GITHUB_REF:-}" == refs/tags/* ]]; then
            cp "dist/${DMG_NAME}" "dist/${PRODUCT_NAME}-${GITHUB_REF_NAME}.dmg"
          fi

      - name: Publish Latest Release (default branch)
        if: github.ref == format('refs/heads/{0}', github.event.repository.default_branch)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: PRPulse latest
          prerelease: true
          make_latest: false
          target_commitish: ${{ github.sha }}
          files: |
            dist/PRPulseApp.dmg
          overwrite_files: true

      - name: Publish Versioned Release (tags only)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          overwrite_files: true
          files: |
            dist/PRPulseApp-${{ github.ref_name }}.dmg

      - name: Upload workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: PRPulseApp-macos-${{ github.sha }}
          path: |
            dist/PRPulseApp.dmg
            dist/*.zip
            dist/*.tar.gz
